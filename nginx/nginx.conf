# user nginx;  # 注释掉，在非 root 用户下会被忽略
worker_processes auto;
error_log /tmp/nginx/logs/error.log warn;
# pid /tmp/nginx/nginx.pid;  # 通过启动命令的 -g 参数指定

events {
    worker_connections 1024;
}

http {
    # 临时文件目录（避免权限问题）
    client_body_temp_path /tmp/nginx/body;
    proxy_temp_path /tmp/nginx/proxy;
    fastcgi_temp_path /tmp/nginx/fastcgi;
    uwsgi_temp_path /tmp/nginx/uwsgi;
    scgi_temp_path /tmp/nginx/scgi;
    
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /tmp/nginx/logs/access.log main;
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 100;
    
    # 客户端超时设置
    client_body_timeout 10s;
    client_header_timeout 10s;
    send_timeout 10s;
    
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml text/javascript application/json application/javascript application/xml+rss;
    
    # 上游服务器配置（用于健康检查和负载均衡）
    upstream backend_admin {
        server 127.0.0.1:8085 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }
    
    upstream backend_api {
        server 127.0.0.1:8086 max_fails=3 fail_timeout=30s;
        keepalive 32;
    }

    # 管理员后台前端 (mall4v) - 端口 8080 (非特权端口)
    server {
        listen 8080;
        server_name _;
        
        # JS 文件 - 禁用缓存（开发环境）
        location ~* \.(js|jsx)$ {
            root /tmp/nginx/html/mall4v;
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma "no-cache";
            add_header Expires "0";
        }
        
        # 静态资源
        location / {
            root /tmp/nginx/html/mall4v;
            try_files $uri $uri/ /index.html;
            index index.html;
        }
        
        # 图片资源代理 - 通过 Admin 服务访问
        location /mall4j/img/ {
            proxy_pass http://backend_admin;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 优化超时设置（图片可以稍长一些）
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # 错误处理
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 15s;
            
            # Buffer 配置 - 支持大图片传输
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;
            proxy_max_temp_file_size 0;
            
            # 图片缓存设置
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        # API 反向代理 - 管理接口
        location /apis/ {
            rewrite ^/apis/(.*)$ /$1 break;
            proxy_pass http://backend_admin;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 优化超时设置
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # 错误处理
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 10s;
        }
        
        # 智能客服配置接口（在 API 服务中）
        location ~ ^/apis/admin/chatbot/config {
            rewrite ^/apis/(.*)$ /$1 break;
            proxy_pass http://backend_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 优化超时设置
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # 错误处理
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 10s;
        }
        
        # Swagger 文档
        location /doc.html {
            proxy_pass http://backend_admin/doc.html;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # 优化超时设置
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
    }

    # 用户H5端 (mall4uni) - 端口 8081 (非特权端口)
    server {
        listen 8081;
        server_name _;
        
        # 根路径重定向
        location = / {
            return 301 /h5/;
        }
        
        # 图片资源代理 - /h5/mall4j/img/ 路径（必须在 /h5/ 之前）
        location /h5/mall4j/img/ {
            rewrite ^/h5(/mall4j/img/.*)$ $1 break;
            proxy_pass http://backend_admin;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 优化超时设置（图片可以稍长一些）
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # 错误处理
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 15s;
            
            # Buffer 配置 - 支持大图片传输
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;
            proxy_max_temp_file_size 0;
            
            # 图片缓存设置
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        # 图片资源代理 - 通过 Admin 服务访问（非 /h5/ 路径）
        location /mall4j/img/ {
            proxy_pass http://backend_admin;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 优化超时设置（图片可以稍长一些）
            proxy_connect_timeout 10s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # 错误处理
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 15s;
            
            # Buffer 配置 - 支持大图片传输
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;
            proxy_max_temp_file_size 0;
            
            # 图片缓存设置
            expires 30d;
            add_header Cache-Control "public, immutable";
        }
        
        # API 反向代理 - 需要去掉 /p/ 前缀的接口（indexImgs, prod, shop, coupon, notice 等）
        location ~ ^/p/(indexImgs|prod|shop|coupon|notice)(/|$) {
            rewrite ^/p/(.*)$ /$1 break;
            proxy_pass http://backend_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 优化超时设置
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # 错误处理
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 10s;
        }
        
        # API 反向代理 - 用户接口（/p/ 前缀，必须在 /h5/ 之前）
        location /p/ {
            proxy_pass http://backend_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 优化超时设置
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # 错误处理
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 10s;
            
            # 支持流式响应（SSE）
            proxy_buffering off;
            proxy_cache off;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            chunked_transfer_encoding on;
        }
        
        # API 反向代理 - 直接路径（/prod/, /indexImgs, /shop/, /coupon/ 等，必须在 /h5/ 之前）
        location ~ ^/(prod|indexImgs|shop|coupon|notice)/ {
            proxy_pass http://backend_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 优化超时设置
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # 错误处理
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 10s;
        }
        
        # 登录接口代理 - 直接代理到后端 API 服务
        location /login {
            proxy_pass http://backend_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 优化超时设置
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # 错误处理
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 10s;
        }
        
        # 用户注册接口代理
        location /user/register {
            proxy_pass http://backend_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 优化超时设置
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # 错误处理
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 10s;
        }
        
        # Token 刷新接口代理
        location /token/refresh {
            proxy_pass http://backend_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # 优化超时设置
            proxy_connect_timeout 5s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
            
            # 错误处理
            proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
            proxy_next_upstream_tries 2;
            proxy_next_upstream_timeout 10s;
        }
        
        # H5 应用路径 - 处理所有 /h5/ 下的请求（包括静态资源，放在最后）
        location /h5/ {
            root /tmp/nginx/html/mall4uni;
            try_files $uri $uri/ /h5/index.html;
            index index.html;
            
            # 静态资源优化
            expires 1h;
            add_header Cache-Control "public, must-revalidate";
            access_log off;
            
            # 禁用缓存 HTML 文件（开发环境）
            location ~* \.(html)$ {
                root /tmp/nginx/html/mall4uni;
                add_header Cache-Control "no-cache, no-store, must-revalidate";
                add_header Pragma "no-cache";
                add_header Expires "0";
            }
        }
    }
}

