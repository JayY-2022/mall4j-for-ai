# 修复数据库中文乱码问题

## 问题原因

1. **表字符集问题**：`tz_prod` 等表使用了 `utf8` 字符集，而不是 `utf8mb4`
   - `utf8` 在 MySQL 中只支持 3 字节的 UTF-8，不支持完整的 Unicode
   - `utf8mb4` 支持完整的 UTF-8（4 字节），包括 emoji 和所有中文字符

2. **数据库连接配置问题**：部分环境的连接字符串缺少 `connectionCollation=utf8mb4_unicode_ci` 参数

## 修复步骤

### 第一步：修复数据库连接配置（已完成）

已修复以下配置文件，添加了 `connectionCollation=utf8mb4_unicode_ci` 参数：
- `yami-shop-api/src/main/resources/application-docker.yml`
- `yami-shop-api/src/main/resources/application-prod.yml`
- `yami-shop-admin/src/main/resources/application-docker.yml`
- `yami-shop-admin/src/main/resources/application-prod.yml`

### 第二步：修复数据库和表的字符集

执行 SQL 脚本修复字符集：

```bash
mysql -u root -p yami_shops < db/fix_charset_utf8mb4.sql
```

或者直接在 MySQL 客户端执行：

```sql
source /path/to/mall4j/db/fix_charset_utf8mb4.sql;
```

### 第三步：处理已存在的乱码数据

**重要提示**：如果数据已经以错误的编码存储，修复字符集后可能仍然显示乱码。有以下几种处理方式：

#### 方案 1：重新导入数据（推荐）

如果数据是从 SQL 文件导入的，可以：

1. 确保 SQL 文件本身是 UTF-8 编码
2. 在导入时指定正确的字符集：
   ```bash
   mysql -u root -p --default-character-set=utf8mb4 yami_shops < your_data.sql
   ```

#### 方案 2：手动修复部分数据

如果只有部分数据乱码，可以手动更新：

```sql
-- 示例：修复产品名称
UPDATE tz_prod SET prod_name = '正确的产品名称' WHERE prod_id = 78;
```

#### 方案 3：使用 Python 脚本修复（如果数据量较大）

可以编写脚本读取乱码数据，尝试不同的编码转换，然后更新回数据库。

### 第四步：验证修复结果

1. 检查表的字符集：
   ```sql
   SELECT 
       TABLE_NAME,
       TABLE_COLLATION
   FROM 
       information_schema.TABLES
   WHERE 
       TABLE_SCHEMA = 'yami_shops'
       AND TABLE_NAME LIKE 'tz_%'
   ORDER BY TABLE_NAME;
   ```

2. 检查数据库字符集：
   ```sql
   SELECT DEFAULT_CHARACTER_SET_NAME, DEFAULT_COLLATION_NAME
   FROM information_schema.SCHEMATA
   WHERE SCHEMA_NAME = 'yami_shops';
   ```

3. 测试插入中文数据：
   ```sql
   INSERT INTO tz_prod (prod_name, shop_id, ori_price, price, status, category_id)
   VALUES ('测试商品名称', 1, 100.00, 99.00, 1, 1);
   
   SELECT prod_name FROM tz_prod WHERE prod_id = LAST_INSERT_ID();
   ```

## 预防措施

1. **新建表时**：始终使用 `DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci`
2. **导入数据时**：确保 SQL 文件是 UTF-8 编码，并使用 `--default-character-set=utf8mb4` 参数
3. **应用程序**：确保数据库连接字符串包含 `connectionCollation=utf8mb4_unicode_ci`
4. **文件编码**：确保所有 SQL 脚本文件保存为 UTF-8 编码

## 注意事项

- 修复字符集操作可能需要一些时间，特别是对于大表
- 建议在修复前备份数据库
- 修复后需要重启应用程序以使用新的连接配置
- 如果数据已经严重乱码，可能需要从原始数据源重新导入

